var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.EthereumEvents = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _construct2 = _interopRequireDefault(require("@babel/runtime/helpers/construct"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _web = _interopRequireDefault(require("web3"));

var _ParseObject = _interopRequireDefault(require("./ParseObject"));

var _ParseQuery = _interopRequireDefault(require("./ParseQuery"));

var _ParseUser = _interopRequireDefault(require("./ParseUser"));

var _ParseACL = _interopRequireDefault(require("./ParseACL"));

var EthereumEvents = {
  CONNECT: 'connect',
  DISCONNECT: 'disconnect',
  ACCOUNTS_CHANGED: 'accountsChanged',
  CHAIN_CHANGED: 'chainChanged'
};
exports.EthereumEvents = EthereumEvents;
var WARNING = 'Non ethereum enabled browser';

function uniq(arr) {
  return arr.filter(function (v, i) {
    return arr.indexOf(v) === i;
  });
}

var MoralisWeb3 = function () {
  function MoralisWeb3() {
    (0, _classCallCheck2.default)(this, MoralisWeb3);
    var MWeb3 = typeof _web.default === 'function' ? _web.default : window.Web3;

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    return (0, _construct2.default)(MWeb3, args);
  }

  (0, _createClass2.default)(MoralisWeb3, null, [{
    key: "enable",
    value: function () {
      var _window$web;

      var MWeb3, provider, ethereum, web3;
      return _regenerator.default.async(function (_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              MWeb3 = typeof _web.default === 'function' ? _web.default : window.Web3;
              provider = (_window$web = window.web3) == null ? void 0 : _window$web.currentProvider;
              ethereum = window.ethereum;

              if (!(provider != null && provider.isTrust)) {
                _context.next = 5;
                break;
              }

              return _context.abrupt("return", new MWeb3(provider));

            case 5:
              if (!ethereum) {
                _context.next = 10;
                break;
              }

              web3 = new MWeb3(ethereum);
              _context.next = 9;
              return _regenerator.default.awrap(ethereum.enable());

            case 9:
              return _context.abrupt("return", web3);

            case 10:
              if (!provider) {
                _context.next = 12;
                break;
              }

              return _context.abrupt("return", new MWeb3(provider));

            case 12:
              throw new Error(WARNING);

            case 13:
            case "end":
              return _context.stop();
          }
        }
      }, null, null, null, Promise);
    }
  }, {
    key: "authenticate",
    value: function () {
      var _user$get;

      var isLoggedIn, web3, data, accounts, accountsLower, _accountsLower, ethAddress, signature, authData, user;

      return _regenerator.default.async(function (_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              _context2.next = 2;
              return _regenerator.default.awrap(_ParseUser.default.current());

            case 2:
              isLoggedIn = _context2.sent;

              if (!isLoggedIn) {
                _context2.next = 6;
                break;
              }

              _context2.next = 6;
              return _regenerator.default.awrap(_ParseUser.default.logOut());

            case 6:
              _context2.next = 8;
              return _regenerator.default.awrap(MoralisWeb3.enable());

            case 8:
              web3 = _context2.sent;
              data = MoralisWeb3.getSigningData();
              _context2.next = 12;
              return _regenerator.default.awrap(web3.eth.getAccounts());

            case 12:
              accounts = _context2.sent;
              accountsLower = accounts.map(function (v) {
                return v.toLowerCase();
              });
              _accountsLower = (0, _slicedToArray2.default)(accountsLower, 1), ethAddress = _accountsLower[0];

              if (ethAddress) {
                _context2.next = 17;
                break;
              }

              throw new Error('Address not found');

            case 17:
              _context2.next = 19;
              return _regenerator.default.awrap(web3.eth.personal.sign(data, ethAddress, ''));

            case 19:
              signature = _context2.sent;

              if (signature) {
                _context2.next = 22;
                break;
              }

              throw new Error('Data not signed');

            case 22:
              authData = {
                id: ethAddress,
                signature: signature,
                data: data
              };
              _context2.next = 25;
              return _regenerator.default.awrap(_ParseUser.default.logInWith('moralisEth', {
                authData: authData
              }));

            case 25:
              user = _context2.sent;
              _context2.next = 28;
              return _regenerator.default.awrap(user.setACL(new _ParseACL.default(user)));

            case 28:
              if (user) {
                _context2.next = 30;
                break;
              }

              throw new Error('Could not get user');

            case 30:
              user.set('accounts', uniq([].concat(accountsLower, (_user$get = user.get('accounts')) != null ? _user$get : [])));
              user.set('ethAddress', ethAddress);
              _context2.next = 34;
              return _regenerator.default.awrap(user.save());

            case 34:
              return _context2.abrupt("return", user);

            case 35:
            case "end":
              return _context2.stop();
          }
        }
      }, null, null, null, Promise);
    }
  }, {
    key: "link",
    value: function (account) {
      var _user$get2;

      var web3, data, user, ethAddress, EthAddress, query, ethAddressRecord, signature, authData;
      return _regenerator.default.async(function (_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              _context3.next = 2;
              return _regenerator.default.awrap(MoralisWeb3.enable());

            case 2:
              web3 = _context3.sent;
              data = MoralisWeb3.getSigningData();
              _context3.next = 6;
              return _regenerator.default.awrap(_ParseUser.default.current());

            case 6:
              user = _context3.sent;
              ethAddress = account.toLowerCase();
              EthAddress = _ParseObject.default.extend('_EthAddress');
              query = new _ParseQuery.default(EthAddress);
              _context3.next = 12;
              return _regenerator.default.awrap(query.get(ethAddress).catch(function () {
                return null;
              }));

            case 12:
              ethAddressRecord = _context3.sent;

              if (ethAddressRecord) {
                _context3.next = 20;
                break;
              }

              _context3.next = 16;
              return _regenerator.default.awrap(web3.eth.personal.sign(data, account, ''));

            case 16:
              signature = _context3.sent;
              authData = {
                id: ethAddress,
                signature: signature,
                data: data
              };
              _context3.next = 20;
              return _regenerator.default.awrap(user.linkWith('moralisEth', {
                authData: authData
              }));

            case 20:
              user.set('accounts', uniq([ethAddress].concat((_user$get2 = user.get('accounts')) != null ? _user$get2 : [])));
              user.set('ethAddress', ethAddress);
              _context3.next = 24;
              return _regenerator.default.awrap(user.save());

            case 24:
              return _context3.abrupt("return", user);

            case 25:
            case "end":
              return _context3.stop();
          }
        }
      }, null, null, null, Promise);
    }
  }, {
    key: "unlink",
    value: function (account) {
      var _user$get3;

      var accountsLower, EthAddress, query, ethAddressRecord, user, accounts, nextAccounts;
      return _regenerator.default.async(function (_context4) {
        while (1) {
          switch (_context4.prev = _context4.next) {
            case 0:
              accountsLower = account.toLowerCase();
              EthAddress = _ParseObject.default.extend('_EthAddress');
              query = new _ParseQuery.default(EthAddress);
              _context4.next = 5;
              return _regenerator.default.awrap(query.get(accountsLower));

            case 5:
              ethAddressRecord = _context4.sent;
              _context4.next = 8;
              return _regenerator.default.awrap(ethAddressRecord.destroy());

            case 8:
              _context4.next = 10;
              return _regenerator.default.awrap(_ParseUser.default.current());

            case 10:
              user = _context4.sent;
              accounts = (_user$get3 = user.get('accounts')) != null ? _user$get3 : [];
              nextAccounts = accounts.filter(function (v) {
                return v !== accountsLower;
              });
              user.set('accounts', nextAccounts);
              user.set('ethAddress', nextAccounts[0]);
              _context4.next = 17;
              return _regenerator.default.awrap(user._unlinkFrom('moralisEth'));

            case 17:
              _context4.next = 19;
              return _regenerator.default.awrap(user.save());

            case 19:
              return _context4.abrupt("return", user);

            case 20:
            case "end":
              return _context4.stop();
          }
        }
      }, null, null, null, Promise);
    }
  }, {
    key: "on",
    value: function (eventName, cb) {
      var ethereum = window.ethereum;

      if (!ethereum || !ethereum.on) {
        console.warn(WARNING);
        return function () {
          console.warn(WARNING);
        };
      }

      ethereum.on(eventName, cb);
      return function () {
        console.warn('UNSUB NOT SUPPORTED');
      };
    }
  }, {
    key: "getSigningData",
    value: function () {
      return "Moralis Authentication";
    }
  }]);
  return MoralisWeb3;
}();

MoralisWeb3.onConnect = MoralisWeb3.on.bind(MoralisWeb3, EthereumEvents.CONNECT);
MoralisWeb3.onDisconnect = MoralisWeb3.on.bind(MoralisWeb3, EthereumEvents.DISCONNECT);
MoralisWeb3.onChainChanged = MoralisWeb3.on.bind(MoralisWeb3, EthereumEvents.CHAIN_CHANGED);
MoralisWeb3.onAccountsChanged = MoralisWeb3.on.bind(MoralisWeb3, EthereumEvents.ACCOUNTS_CHANGED);
var _default = MoralisWeb3;
exports.default = _default;